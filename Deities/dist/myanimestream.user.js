// ==UserScript==
// @name MyAnimeStream
// @author siku2
// @version 2.0.0
// @description Get the most out of your favourite anime site by turning it into a streaming site.
// @homepage https://mas.dokkeral.com/
// @downloadURL https://mas.dokkeral.com/download
// @icon https://mas.dokkeral.com/images/logo
// @include /^http(?:s)?\:\/\/myanimelist\.net.*$/
// @include /^http(?:s)?\:\/\/kitsu\.io.*$/
// @noframes True
// @run-at document-start
// @require https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js
// @require https://cdn.jsdelivr.net/npm/raven-js@3.26.3/dist/raven.min.js
// @require https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js
// @require https://cdn.jsdelivr.net/npm/plyr@3.3.10/dist/plyr.min.js
// ==/UserScript==
function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function o(i,s){try{var a=t[i](s),r=a.value}catch(e){return void n(e)}if(!a.done)return Promise.resolve(r).then(function(e){o("next",e)},function(e){o("throw",e)});e(r)}("next")})}}var myanimestream=function(e,t,n,o,i){"use strict";let s=(a=_asyncToGenerator(function*(){if(Object.assign(Te,Se),qe){let e;try{e=yield t.getJSON(we+"/user/"+qe+"/config")}catch(e){console.warn("config: couldn't load config"),n.captureMessage("Couldn't retrieve config.",{level:"warning",extra:{error:e}})}e&&e.success&&(Object.assign(Te,e.config),console.log("config: loaded config"))}else console.warn("config: Can't load config (user not logged in)")}),function(){return a.apply(this,arguments)});var a;let r=(l=_asyncToGenerator(function*(){if(qe){console.debug("config: saving config");const e=yield t.postJSON(we+"/user/"+qe+"/config",Te);return e.success?(console.log("config: saved config"),!0):(n.captureMessage("Couldn't save config.",{level:"warning",extra:{response:e}}),!1)}console.warn("config: can't save config (user not logged in)")}),function(){return l.apply(this,arguments)});var l;let c=(d=_asyncToGenerator(function*(e){alert(e)}),function(e){return d.apply(this,arguments)});var d;let u=(p=_asyncToGenerator(function*(e){Ce||(Ce=JSON.parse(localStorage.getItem("AnimeUIDs"))||{});const t=yield xe.dub,n=Ce[t?"dub":"sub"];if(n)return n[e]}),function(e){return p.apply(this,arguments)});var p;let f=(m=_asyncToGenerator(function*(e,t){const n=(yield xe.dub)?"dub":"sub",o=(Ce=JSON.parse(localStorage.getItem("AnimeUIDs"))||{})[n];o?o[e]=t:Ce[n]={[e]:t},localStorage.setItem("AnimeUIDs",JSON.stringify(Ce))}),function(e,t){return m.apply(this,arguments)});var m;let g=(h=_asyncToGenerator(function*(){if(!$e.status)return;if("WATCHING"!==$e.status)return void console.log("api: not watching this anime");console.debug("api: setting episodesAvailable to",$e.episodesAvailable,"");const e=Ge($e.name),t={};t[e+".uid"]=$e.uid,t[e+".episodesAvailable"]=$e.episodesAvailable,yield $.postJSON(we+"/user/"+qe+"/episodes",t)}),function(){return h.apply(this,arguments)});var h;let y=(v=_asyncToGenerator(function*(e,t){$e.name=e,$e.status=t,$e.uid=yield u(e);let o,s=!1;if($e.uid&&((o=yield $.getJSON(we+"/anime/"+$e.uid)).success?s=!0:console.warn('api: Unsuccessful request for uid "'+$e.uid+'":',o,"")),!s){console.log("api: Searching for anime",e,"");const t=yield $.getJSON(we+"/search/"+e,{dub:yield xe.dub});t.success?(console.log("api: got answer",t,""),o=t.anime[0].anime,$e.uid=o.uid,f(e,$e.uid),s=!0):console.error("api: Couldn't find anime \""+e+'"')}return s?($e.episodesAvailable=o.episodes,g(),!0):(function(){if(function(e,t=1){const n="msg-"+e;return!i.get(n)&&(i.set(n,"true",{expires:t}),!0)}(`${$e.name.replace(/\W+/g,"").toLowerCase()}-not-found`)){let e="Couldn't find \""+$e.name+'"!';return n.isSetup()&&(e+=" A report has been created for you and you can expect for this anime to be available soon",n.captureMessage('Anime "'+$e.name+'" not found.',{level:"info"})),c(e)}console.log("messages: Already warned about missing anime"),Promise.resolve()}(),!1)}),function(e,t){return v.apply(this,arguments)});var v;let b=(w=_asyncToGenerator(function*(){t(".changelog-popup-container").remove(),t("body").removeClass("frozen"),yield xe.set("lastVersion",GM_info.script.version),console.log("changelog: updated version")}),function(){return w.apply(this,arguments)});var w;let S=(_=_asyncToGenerator(function*(e,n){const o=yield t.get(we+"/templates/changelog/"+n+"/"+e);if(!1===o.success)return void console.log("changelog: no changes to show");t.injectCSS({"body.frozen":{overflow:"hidden"},".changelog-popup-container":{display:"flex","justifyContent, alignItems":"center",position:"absolute","top, left":0,"width, height":"100%",zIndex:1e3,backgroundColor:"hsla(0, 0%, 0%, 0.5)"},".changelog-popup":{zIndex:2e3,minWidth:"30vw",height:"90%"}});const i=t("<div class='changelog-popup-container'></div>").appendTo("body");t("<div class='changelog-popup'></div>").html(o).appendTo(i),t("body").addClass("frozen"),t("button.close-changelog-btn").click(b)}),function(e,t){return _.apply(this,arguments)});var _;let A=(T=_asyncToGenerator(function*(){const e=GM_info.script.version;if(qe){const t=yield xe.lastVersion;if(!t)return console.log("changelog: No remote version... Setting to",e,""),void(yield xe.set("lastVersion",e));!function(e,t){if(e===t)return null;const n=e.split("."),o=t.split("."),i=Math.min(n.length,o.length);for(let e=0;e<i;e++){if(parseInt(n[e])>parseInt(o[e]))return!0;if(parseInt(n[e])<parseInt(o[e]))return!1}if(n.length>o.length)return!0;if(n.length<o.length)return!1}(e,t)?console.debug("changelog: no new version"):(console.log("changelog: showing changelog"),yield S(e,t))}else console.log("changelog: not checking for update because user isn't logged in")}),function(){return T.apply(this,arguments)});var T;let x=(k=_asyncToGenerator(function*(){(yield xe.updateAnimeStatus)||console.log("kitsu/pages/anime/episode: Not updating anime status because of user settings"),console.log("kitsu/pages/anime/episode: finished Episode")}),function(){return k.apply(this,arguments)});var k;let G=(E=_asyncToGenerator(function*(){if(yield x(),Pe+1<$e.episodesAvailable){const e=new URL((Pe+2).toString(),window.location.href);e.searchParams.set("autoplay","true"),window.location.href=e.toString()}else console.log("kitsu/pages/anime/episode: reached the last episode")}),function(){return E.apply(this,arguments)});var E;let N=(C=_asyncToGenerator(function*(){if(!(void 0).ended){const e=(void 0).currentTime/(void 0).duration;e>(yield xe.minWatchPercentageForSeen)&&(console.log("kitsu/pages/anime/episode: Left page with video at "+Math.round(100*e).toString()+"% Counting as finished!"),yield x());const t=new URL(window.location.href);t.searchParams.delete("autoplay"),history.pushState(null,null,t.toString())}}),function(){return C.apply(this,arguments)});var C;let q=(P=_asyncToGenerator(function*(e){Pe=e,console.log("kitsu/pages/anime/episode: Creating video embed");const n=yield t.get(we+"/templates/player/"+$e.uid+"/"+e.toString());!1!==n.success?(t(n).insertAfter("div.unit-summary"),Ne(G,N),Le(e)):function(e){c(`Couldn't find episode ${e+1}!`)}(e)}),function(e){return P.apply(this,arguments)});var P;let M=(I=_asyncToGenerator(function*(e){const t=document.querySelector("meta[property='og:title']").getAttribute("content");if(yield y(t,"ABSENT"),e.match(/^\/episodes\/\d+\/?$/)){const t=parseInt(e.match(/^\/episodes\/(\d+)\/?$/)[1]);yield q(t-1)}}),function(e){return I.apply(this,arguments)});var I;let L=(O=_asyncToGenerator(function*(e,t){let n=document.querySelector(e);for(;!n;)yield ke(t),n=document.querySelector(e);return n}),function(e,t){return O.apply(this,arguments)});var O;let j=(U=_asyncToGenerator(function*(e){console.log("kitsu/index: starting url watcher");let t=location.href;for(;;)location.href!==t&&(console.log("kitsu/index: URL changed"),De.href=location.href,e(),t=location.href),yield ke(100)}),function(e){return U.apply(this,arguments)});var U;let B=(J=_asyncToGenerator(function*(e){console.debug("kitsu/index: waiting for Kitsu"),yield L("div.ember-view",20),console.info("kitsu/index: Kitsu loaded"),Me||(Me=j(function(){return B(location.pathname)}));const t=document.querySelector("a.dropdown-item[href^='/users/']");t&&Ie(t.getAttribute("href").slice(7)),Fe(),e.match(/^\/anime\/[\w-]+/)?yield M(e.replace(/^\/anime\/[\w-]+/,"")):e.match(/^\/settings\//)&&(Ue.addSettingsButton(),De.searchParams.has("myanimestream")?yield Ue.show():Ue.hide())}),function(e){return J.apply(this,arguments)});var J;let z=(R=_asyncToGenerator(function*(){let e;for(;!e||e.length<=1;)e=$("table.list-table tbody.list-item"),yield ke(100);const t=e.filter(function(e,t){return $(t).find("td.data.status").hasClass("watching")}),n=[];for(const e of t)n.push(new ze($(e)));return n}),function(){return R.apply(this,arguments)});var R;let V=(W=_asyncToGenerator(function*(e,t){if(qe||console.log("mal/pages/list: not logged in -> not caching anime list"),e)for(const n of t){const t=e[n.safeName];t&&(n._uid=t.uid,n.episodesPreviouslyAvailable=t.episodesAvailable,n.show())}else console.debug("mal/pages/list: No Anime List cached")}),function(e,t){return W.apply(this,arguments)});var W;let D=(H=_asyncToGenerator(function*(e){qe||console.log("mal/pages/list: not logged in -> not caching anime list");const t={};for(const n of e)t[n.safeName]={uid:n._uid,episodesAvailable:n.episodesAvailable};yield $.postJSON(we+"/user/"+qe+"/episodes",t)}),function(e){return H.apply(this,arguments)});var H;let F=(K=_asyncToGenerator(function*(){t("<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/balloon-css/0.5.0/balloon.min.css'>").appendTo("head"),$.injectCSS({".episode-status.new-episode":{"font-weight":"bolder",color:"#787878 !important"}});const[e,n]=yield Promise.all([$.getJSON(we+"/user/"+qe+"/episodes"),z()]),o=V(e,n),i={};for(const e of n)(yield e.uid)&&(i[yield e.uid]=e);const s=yield $.postJSON(we+"/anime/episode-count",Object.keys(i));s.success?(yield o,Object.entries(s.anime).forEach(function([e,t]){return i[e].episodesAvailable=t}),n.forEach(function(e){return e.show()}),yield D(n)):console.warn("mal/pages/list: Got turned down when asking for episode counts: ",s,"")}),function(){return K.apply(this,arguments)});var K;let Q=(Y=_asyncToGenerator(function*(){$("div#content div form").serializeArray().forEach(function(e){xe[e.name]=function(e){switch(e){case"true":return!0;case"false":return!1}}(e.value)}),(yield r())?$("#update_success_display").show():$("#update_fail_display").show()}),function(){return Y.apply(this,arguments)});var Y;let Z=(X=_asyncToGenerator(function*(){console.log("mal/pages/settings: Building settings page"),document.querySelector("div#horiznav_nav a[href$=myanimestream]").classList.add("horiznav_active"),document.querySelector("div#content div form").parentElement.innerHTML=yield $.get(we+"/templates/mal/settings",yield xe.all),document.querySelector("input[name=submit]").addEventListener("click",Q)}),function(){return X.apply(this,arguments)});var X;let ee=(te=_asyncToGenerator(function*(e){const n=t("#myinfo_status"),o=t("#myinfo_score"),i=t("#myinfo_watchedeps"),s={csrf_token:t('meta[name="csrf_token"]').attr("content"),anime_id:parseInt(t("#myinfo_anime_id").val()),status:parseInt(n.val()),score:parseInt(o.val()),num_watched_episodes:parseInt(i.val())||0};Object.assign(s,e),navigator.sendBeacon("/ownlist/anime/edit.json",JSON.stringify(s)),n.val(s.status),o.val(s.score),i.val(s.num_watched_episodes)}),function(e){return te.apply(this,arguments)});var te;let ne=(oe=_asyncToGenerator(function*(){(yield xe.updateAnimeStatus)||console.log("mal/pages/anime/episode: Not updating anime status because of user settings");const e=parseInt(t("#curEps").text()),n={status:Re>=e?2:1},o=parseInt(t("#myinfo_watchedeps").val())||0;Re>=o&&(n.num_watched_episodes=Re),console.log("mal/pages/anime/episode: updating data to:",n,""),yield ee(n)}),function(){return oe.apply(this,arguments)});var oe;let ie=(se=_asyncToGenerator(function*(){if(yield ne(),Re+1<=$e.episodesAvailable){const e=new URL((Re+1).toString(),window.location.href);e.searchParams.set("autoplay","true"),window.location.href=e.toString()}else console.log("mal/pages/anime/episode: reached the last episode")}),function(){return se.apply(this,arguments)});var se;let ae=(re=_asyncToGenerator(function*(){if(!(void 0).ended){const e=(void 0).currentTime/(void 0).duration;e>(yield xe.minWatchPercentageForSeen)&&(console.log("mal/pages/anime/episode: Left page with video at "+Math.round(100*e).toString()+"% Counting as finished!"),yield ne());const t=new URL(window.location.href);t.searchParams.delete("autoplay"),history.pushState(null,null,t.toString())}}),function(){return re.apply(this,arguments)});var re;let le=(ce=_asyncToGenerator(function*(e){const n=yield t.get(we+"/templates/player/"+$e.uid+"/"+(Re-1).toString());e.html(n),Ve()}),function(e){return ce.apply(this,arguments)});var ce;let de=(ue=_asyncToGenerator(function*(){Re=parseInt(window.location.pathname.match(/^\/anime\/\d+\/[\w-]+\/episode\/(\d+)\/?$/)[1]);const e=t("div.video-embed.clearfix");if(e.length>0){document.querySelector("div.di-b>a").setAttribute("href","../episode");const n=parseInt(t("li.btn-anime:last span.episode-number")[0].innerText.split(" ")[1]);if(n<$e.episodesAvailable){const e=document.querySelector("#vue-video-slide"),o=t("li.btn-anime:last").clone().removeClass("play").remove("span.icon-pay");o.find("div.text").html('<span class="episode-number"></span>'),o.find("img.fl-l").attr("src",we+"/images/default_poster");for(let t=n;t<$e.episodesAvailable;t++){const n=o.clone(),i=(t+1).toString();n.find("span.episode-number").text("Episode "+i),n.find("a.link").attr("href",i),n.appendTo(e)}}(yield xe.replaceStream)?(console.log("mal/pages/anime/episode: Manipulating player"),le(e),t("div.information-right.fl-r.clearfix").remove()):console.info("mal/pages/anime/episode: Not changing player because of user settings")}else console.log("mal/pages/anime/episode: Creating new video embed and page content"),document.querySelector("td>div.js-scrollfix-bottom-rel>div>div>table>tbody").innerHTML=yield t.get(we+"/templates/mal/episode/"+$e.uid+"/"+(Re-1).toString()),Ve();document.querySelector("#vue-video-slide").style.left=(-document.querySelector("li.btn-anime.play").offsetLeft).toString()+"px",Le(Re-1)}),function(){return ue.apply(this,arguments)});var ue;let pe=(fe=_asyncToGenerator(function*(){const e=document.querySelector("table.episode_list"),t=parseInt(De.searchParams.get("offset"))||0;if(e){console.log("mal/pages/anime/episodes: Manipulating existing episode table...");const n=e.querySelectorAll("tr.episode-list-data").length,o=parseInt(e.querySelector("tr.episode-list-data:last-child td.episode-number").innerText);if(100===n)console.log("mal/pages/anime/episodes: episode table paginated...");else if(o<$e.episodesAvailable){const t=document.querySelector("table.episode_list.descend tr.episode-list-header"),n=document.querySelector("tr.episode-list-data").cloneNode(!0);n.querySelector("td.episode-title").querySelector("span.di-ib").innerText="",n.querySelector("td.episode-aired").remove(),n.querySelector("td.episode-forum").remove();for(let i=o+1;i<$e.episodesAvailable;i++){let o=(i+1).toString(),s=$(n).clone();s.find("td.episode-number").text(o),s.find("td.episode-title").find("a").text("Episode "+o).attr("href","episode/"+o),s.find("td.episode-video>a").attr("href","episode/"+o).find("img").attr("alt","Watch Episode #"+o),s.appendTo(e),s.clone().insertAfter(t)}}else console.log("mal/pages/anime/episodes: They've done their job, this table is complete");!function(e){const t=document.querySelector("div.pagination");t&&(console.log("mal/pages/anime/episodes: removing existing pagination"),t.parentElement.remove());if($e.episodesAvailable<=100)return void console.log("mal/pages/anime/episodes: no pagination needed");console.log("mal/pages/anime/episodes: building pagination");const n=$("<div></div>").addClass("pagination ac");if(e>200){const t=0===e?"link current":"link";n.append('<a class="'+t+'" href="?offset=0">1 - 100</a><span class="skip">&lt;</span>')}for(let t=Math.max(e-200,0);t<Math.min(e+300,$e.episodesAvailable);t+=100){const o=e===t?"link current":"link";n.append('<a class="'+o+'" href="?offset='+t+'">'+(t+1).toString()+" - "+Math.min(t+100,$e.episodesAvailable).toString()+"</a>")}if($e.episodesAvailable-e>300){const t=100*Math.floor(($e.episodesAvailable-1)/100),o=e===t?"link current":"link";n.append('<span class="skip">&gt;</span><a class="'+o+'" href="?offset='+t+'">'+t.toString()+" - "+$e.episodesAvailable.toString()+"</a>")}$('<div class="mt12 mb12"></div>').append(n).insertAfter("div.js-scrollfix-bottom-rel>div>table")}(t)}else console.log("mal/pages/anime/episodes: Creating episode table..."),document.querySelector("div.mb4").outerHTML=yield $.get(we+"/templates/mal/episode/"+$e.uid,{offset:t});const n=document.querySelector("h2>span.di-ib");n.innerText="("+$e.episodesAvailable.toString()+"/"+n.innerText.split("/")[1]}),function(){return fe.apply(this,arguments)});var fe;let me=(ge=_asyncToGenerator(function*(){const e=De.pathname,t=document.querySelector("h1>span[itemprop=name]").innerText,n=document.getElementById("showAddtolistAnime")?"ABSENT":document.querySelector("#myinfo_status option[selected]").innerHTML.toUpperCase();yield y(t,n),function(){if(!document.querySelector('li a[href$="/episode"]')){console.log("mal/pages/anime/_router: No Episodes tab found, building my own");const e=document.querySelector("div#horiznav_nav li:nth-child(2)"),t=$("<li><a href="+window.location.pathname+"/episode/1>Watch</a></li>");document.querySelector("a.horiznav_active")||t.find("a").addClass("horiznav_active"),t.insertAfter(e)}}(),e.match(/^\/anime\/\d+\/[\w-]+\/?$/)?function(){const e=document.getElementById("myinfo_watchedeps"),t=$("div.user-status-block.js-user-status-block"),n=parseInt(e.getAttribute("value"))+1||1;if(n<=$e.episodesAvailable){const e=new URL(window.location.href);e.pathname+="/episode/"+n.toString(),e.searchParams.set("autoplay","true"),$("<a></a>").text((1===n?"Start":"Continue")+" Watching").addClass("inputButton btn-middle").css("padding","4px 12px").css("margin-left","8px").css("color","white").attr("href",e.toString()).appendTo(t)}}():e.match(/^\/anime\/\d+\/[\w-]+\/episode\/?$/)?yield pe():e.match(/^\/anime\/\d+\/[\w-]+\/episode\/\d+\/?$/)?yield de():console.warn("mal/pages/anime/_router: Unknown anime page")}),function(){return ge.apply(this,arguments)});var ge;let he=(ye=_asyncToGenerator(function*(){Ie(unsafeWindow.MAL.USER_NAME),Fe(function(){let e=null;null===e&&(e=!!document.querySelector("a.footer-desktop-button"));return e}()),new MutationObserver(Je).observe(document.body,{childList:!0}),console.log("mal/ad-remove: observing body!"),Je();const e=De.pathname;We.indexOf(e)>-1&&function(){const e=document.querySelector("div#horiznav_nav ul");if(e){console.log("mal/pages/settings: Attaching MyAnimeStream settings");const t=document.createElement("li"),n=document.createElement("a");n.setAttribute("href","/editprofile.php?go=myanimestream"),n.innerText="MyAnimeStream",t.appendChild(n),e.appendChild(t)}else console.log("mal/pages/settings: Couldn't find navbar. Not adding Settings!"),n.captureMessage("Couldn't add MyAnimeStream settings button (nav not found)",{level:"warning"})}(),e.match(/^\/anime\/\d+\/[\w-]+\/?/)?yield me():e.match(/^\/animelist\/\w+$/)?function(){const e=parseInt(De.searchParams.get("status"));F(),6===e&&function(){const e=$("#show-stats-button");e.clone().attr("id","open-random-anime").html('<i class="fa fa-random"></i> Random Anime').click(function(){let e;for(;;){const t=$(Ee($("tbody.list-item td.title")));if("Not Yet Aired"!==t.find("span.content-status").text().trim()){e=t.find("a.link");break}}console.log('mal/pages/list: randomly selected "',e.text(),'"'),window.location.href=e.attr("href")}).insertBefore(e)}()}():e.match(/^\/editprofile\.php$/)&&"myanimestream"===De.searchParams.get("go")&&(yield Z())}),function(){return ye.apply(this,arguments)});var ye;t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,o=o&&o.hasOwnProperty("default")?o.default:o,t(document).ajaxError(function(e,t,o,i){n.captureMessage(i||t.statusText,{extra:{type:o.type,url:o.url,data:o.data,status:t.status,error:i||t.statusText,response:t.responseText.substring(0,100)}})});const ve={truncateFirst:!1,container:null,containerName:"injectCSSContainer",useRawValues:!0};var be;(be=t).injectCSS=function(e,t){(t=be.extend({},ve,t)).media=t.media||"all";let n=t.container&&be(t.container)||be("#"+t.containerName);n.length||(n=be("<style></style>").appendTo("head").attr({media:t.media,id:t.containerName,type:"text/css"}));let o="";return t.truncateFirst||(o+=n.text()),o+=function(e,t){function n(e,t){const n=[],o=t.split(/\s*,\s*/),i=e.split(/\s*,\s*/);for(let e=0;e<i.length;e++){const t=i[e];for(let e=0;e<o.length;e++){const i=o[e];"&"===i.charAt(0)?n.push(t+i.substr(1)):n.push(t?t+" "+i:i)}}return n.join(", ")}function o(e,n,o){n=n.replace(/([a-z]*)([A-Z])([a-z]+)/g,(e,t,n,o)=>`${t}-${n.toLowerCase()}${o}`),"number"!=typeof o||t.useRawValues||(o+="px");const s=n.split(/\s*,\s*/);for(let t=0;t<s.length;t++){const n=s[t].replace(/_/g,"-");i[e][n]?i[e][n].push(o):i[e][n]=[o]}}const i={};!function e(t,s){t&&!i[t]&&(i[t]={});for(const i of Object.keys(s)){const a=s[i];if(a instanceof Array){const e=a;for(let n=0;n<e.length;n++)o(t,i,e[n])}else switch(typeof a){case"number":case"string":o(t,i,a);break;case"object":{const s=i.charAt(i.length-1);if(!t||"_"!==s&&"-"!==s)e(n(t,i),a);else{const e=a;for(const n of Object.keys(e)){const s=n.split(/\s*,\s*/);for(let a=0;a<s.length;a++){const r=e[n];if(r instanceof Array){const e=r;for(let n=0;n<e.length;n++)o(t,i+s[a],e[n])}else o(t,i+s[a],e[n])}}}break}}}}("",e);let s="";for(const e of Object.keys(i)){const t=i[e];s+=e+" {\n";for(const e of Object.keys(t)){const n=t[e];for(let t=0;t<n.length;t++)s+="\t"+e+": "+n[t]+";\n"}s+="}\n"}return s}(e,t),n.text(o),n},function(e){e.postJSON=function(t,n){return e.ajax({type:"POST",contentType:"application/json",url:t,data:JSON.stringify(n)})}}(t);const we="https://mas.dokkeral.com",Se={lastVersion:null,dub:!1,replaceStream:!0,updateAnimeStatus:!0,minWatchPercentageForSeen:.75};let _e,Ae=!1;const Te={set:(e,t)=>_asyncToGenerator(function*(){Te[e]=t,yield r()})()},xe=new Proxy(Te,{get:(e,t)=>t in e&&Object.keys(Se).indexOf(t)<0?e[t]:_asyncToGenerator(function*(){return Ae||(_e||(_e=s()),yield _e,Ae=!0),"all"===t?Te:Te[t]})()});function ke(e){return new Promise(t=>setTimeout(t,e))}function Ge(e){return e.replace(/\./g,"")}function Ee(e){return e[Math.floor(Math.random()*e.length)]}function Ne(e,t,n){let i;const s=document.getElementById("player");return s?(i=new o(s),"true"===De.searchParams.get("autoplay")&&i.play(),i.on("ended",e),window.addEventListener("beforeunload",t)):(console.warn("utils: Couldn't find player, assuming this is an iframe!"),n&&n()),i}let Ce;const $e={uid:null,name:null,episodesAvailable:null,status:null};let qe,Pe,Me;function Ie(e){qe=e}function Le(e){console.log("api: prefetching next episode"),$.get(we+"/anime/"+$e.uid+"/"+(e+1).toString()+"/preload")}class Oe{static get singleton(){return this._singleton||(this._singleton=new this),this._singleton}static show(){var e=this;return _asyncToGenerator(function*(){const t=e.singleton;yield t.render()})()}render(){return _asyncToGenerator(function*(){})()}}class je extends Oe{static addSettingsButton(){}render(){var e=this;return _asyncToGenerator(function*(){yield e.showSettings()})()}showSettings(){return _asyncToGenerator(function*(){})()}formParseValue(e){switch(e){case"true":return!0;case"false":return!1}}submitSettings(e){var t=this;return _asyncToGenerator(function*(){return e.forEach(function(e){xe[e.name]=t.formParseValue(e.value)}),yield r()})()}}class Ue extends je{static addSettingsButton(){if(document.querySelector("ul.settings--navigation li.myanimestream"))return void console.log("kitsu/pages/settings: myanimestream tab already exists");const e=document.querySelector("ul.settings--navigation");if(e){console.log("kitsu/pages/settings: Attaching MyAnimeStream settings");const t=document.createElement("li");t.classList.add("list-item","ember-view","myanimestream");const n=document.createElement("a");n.setAttribute("href","javascript:;"),n.innerText="MyAnimeStream",n.addEventListener("click",()=>history.pushState(null,null,"/settings/account?myanimestream")),t.appendChild(n),e.appendChild(t)}}static hide(){document.querySelector("ul.settings--navigation li.myanimestream").classList.remove("active")}showSettings(){var e=this;return _asyncToGenerator(function*(){console.log("kitsu/pages/settings: Building settings page"),document.querySelector("ul.settings--navigation li.active").classList.remove("active"),document.querySelector("ul.settings--navigation li.myanimestream").classList.add("active"),document.querySelector("div.settings-container").innerHTML=yield $.get(we+"/templates/kitsu/settings",yield xe.all),document.querySelector("input[name=submit]").addEventListener("click",e.submitSettings)})()}}const Be=["Notice us","ads help us pay the bills"];function Je(){Array.from(document.getElementsByTagName("*")).filter(e=>{if(!e.firstChild)return;let t=e.firstChild.nodeValue;return t?Boolean(Be.find(e=>t.includes(e))):void 0}).forEach(e=>{for(let t=0;t<5;t++)e=e.parentElement;console.log("mal/ad-remove: removed ad",e,""),e.remove()})}class ze{constructor(e){this.el=e}get name(){return this.el.find("td.title a.link").text()}get safeName(){return Ge(this.name)}get link(){return this.el.find("td.title a.link").attr("href")}get uid(){var e=this;return _asyncToGenerator(function*(){return e._uid||(e._uid=yield u(e.name)),e._uid})()}get uidValid(){var e=this;return _asyncToGenerator(function*(){return(yield e.uid)&&e.episodesAvailable>=0})()}get episodesPreviouslyAvailable(){return this._episodesPreviouslyAvailable}set episodesPreviouslyAvailable(e){this._episodesPreviouslyAvailable=e}get episodesAvailable(){return isNaN(this._episodesAvailable)?this.episodesPreviouslyAvailable:this._episodesAvailable}set episodesAvailable(e){this._episodesAvailable=e}get currentEpisode(){const e=this.el.find("td.progress span a").text();return parseInt(e)||0}get nUnseenEpisodes(){return this.episodesAvailable-this.currentEpisode||0}get nNewEpisodes(){return this.episodesAvailable-this.episodesPreviouslyAvailable||0}removePrevious(){this.el.find(".episode-status").remove()}show(){var e=this;return _asyncToGenerator(function*(){let t,n,o;const i=["content-status","episode-status"];if((yield e.uidValid)?e.nNewEpisodes>0?(t=1===e.nNewEpisodes?"new episode!":"new episodes!",i.push("new-episode"),n="There "+(1===e.nNewEpisodes?"is an episode":"are "+e.nNewEpisodes.toString()+" episodes")+" you haven't watched yet!",o=e.link+"/episode/"+(e.currentEpisode+1).toString()):e.nUnseenEpisodes>0&&(t=1===e.nUnseenEpisodes?"unseen episode!":"unseen episodes!",i.push("unseen-episode"),n="There "+(1===e.nUnseenEpisodes?"is an episode":"are "+e.nUnseenEpisodes.toString()+" episodes")+" you haven't watched yet!",o=e.link+"/episode/"+(e.currentEpisode+1).toString()):(yield e.uid)?(t="uid invalid",n="There was a UID cached but the server didn't accept it. Just open the anime page and it should fix itself"):(t="unknown uid",n="There was no UID cached. Just open the anime page and it should fix itself"),t){const s=e.el.find("td.title span.content-status");let a;e.removePrevious(),s.is(":visible")&&(t="| "+t),(a=o?$("<a></a>").attr("href",o):$("<span></span>")).text(t),i.forEach(function(e){return a.addClass(e)}),n&&(a.attr("data-balloon-pos","up"),a.attr("data-balloon",n)),s.after(a)}})()}}let Re;function Ve(){return Ne(ie,ae,()=>{document.querySelector("div#embed-warning")||t("<div id='embed-warning' class='initialize-tutorial'><i class='fa fa-exclamation' style='margin-right: 10px'></i><span>This is an embedded stream (you might've noticed, lol). Please mind that MyAnimeStream won't be able to update your episode status because of this!</span></div>").insertBefore(t("div.contents-video-embed"))})}const We=["/editprofile.php","/notification/setting","/ownlist/style","/account/payment"],De=new URL(window.location.href);function He(){let e;switch(De.hostname){case"myanimelist.net":console.info("core: routing MyAnimeList"),e=he;break;case"kitsu.io":console.info("core: routing Kitsu"),e=B}e&&e(De.pathname),A()}function Fe(e){n.isSetup()&&(qe?(console.log("core: Set user context for",qe,""),n.setUserContext({username:qe,mobile:e})):console.log("core: Not logged in"))}return n.config("https://1d91640d1e45402c9a8f80e74c24658b@sentry.io/1207280",{release:GM_info.script.version,tags:{manager_version:GM_info.version},whitelistUrls:[/userscript\.html/g]}).install(),console.info("core: Using Raven DSN!"),n.context(function(){t("<meta name='referrer' content='no-referrer'/>").appendTo("head"),t(He)}),e.currentURL=De,e.addUserContext=Fe,e}({},jQuery,Raven,Plyr,Cookies);
